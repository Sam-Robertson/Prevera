generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
}

enum PlatformRole {
  NONE
  SUPER_ADMIN
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum RecordType {
  NOTE
}

model Clinic {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users   User[]
  invites Invite[]

  patients Patient[]
  records  Record[]
}

model User {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  email String   @unique
  role  UserRole @default(STAFF)

  platformRole PlatformRole @default(NONE)

  // Cognito user unique id (sub). Nullable until they accept invite and sign in.
  cognitoSub String? @unique

  isActive Boolean @default(true)

  lastActiveAt DateTime?

  invitesCreated  Invite[] @relation("InviteInvitedBy")
  invitesAccepted Invite[] @relation("InviteAcceptedBy")
  invitesRevoked  Invite[] @relation("InviteRevokedBy")

  // Records this user created (optional on Record)
  recordsCreated Record[] @relation("UserCreatedRecords")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invite {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  email  String
  role   UserRole     @default(STAFF)
  status InviteStatus @default(PENDING)

  invitedByUserId String?
  invitedByUser   User? @relation("InviteInvitedBy", fields: [invitedByUserId], references: [id])

  acceptedByUserId String?
  acceptedByUser   User? @relation("InviteAcceptedBy", fields: [acceptedByUserId], references: [id])
  acceptedAt       DateTime?

  revokedByUserId String?
  revokedByUser   User? @relation("InviteRevokedBy", fields: [revokedByUserId], references: [id])
  revokedAt       DateTime?

  lastSentAt DateTime?
  sendCount  Int      @default(0)

  tokenHash String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([email])
}

enum PatientStatus {
  ACTIVE
  INACTIVE
}

model Patient {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  firstName String
  lastName  String
  dob       DateTime?

  phone     String?
  email     String?
  mrn       String?
  lastVisit DateTime?

  status PatientStatus @default(ACTIVE)

  // soft delete
  deletedAt DateTime?

  records Record[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([lastName, firstName])
  @@index([clinicId, mrn])
  @@index([clinicId, email])
}


model Record {
  id String @id @default(cuid())

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  createdByUserId String?
  createdByUser   User?   @relation("UserCreatedRecords", fields: [createdByUserId], references: [id])

  type  RecordType @default(NOTE)
  title String?
  body  String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([clinicId])
  @@index([patientId])
  @@index([createdByUserId])
}
